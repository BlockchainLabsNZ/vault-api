

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      Zippie Vault API Reference
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      Zippie Vault API Reference
    </h3>

    

    <h3>Classes</h3><ul><li id="Vault-nav"><a href="Vault.html">Vault</a><ul class='methods'><li data-type="method" id="Vault-enrollments-nav"><a href="Vault.html#enrollments">enrollments</a></li><li data-type="method" id="Vault-getDeviceInfo-nav"><a href="Vault.html#getDeviceInfo">getDeviceInfo</a></li><li data-type="method" id="Vault-getUserData-nav"><a href="Vault.html#getUserData">getUserData</a></li><li data-type="method" id="Vault-message-nav"><a href="Vault.html#message">message</a></li><li data-type="method" id="Vault-setup-nav"><a href="Vault.html#setup">setup</a></li><li data-type="method" id="Vault-setUserData-nav"><a href="Vault.html#setUserData">setUserData</a></li><li data-type="method" id="Vault-signin-nav"><a href="Vault.html#signin">signin</a></li></ul></li></ul><h3>Modules</h3><ul><li id="ipc-nav"><a href="module-ipc.html">ipc</a><ul class='methods'><li data-type="method" id="ipc-createClient-nav"><a href="module-ipc.html#~createClient">createClient</a></li><li data-type="method" id="ipc-createService-nav"><a href="module-ipc.html#~createService">createService</a></li></ul></li><li id="secp256k1-nav"><a href="module-secp256k1.html">secp256k1</a><ul class='methods'><li data-type="method" id="secp256k1-decrypt-nav"><a href="module-secp256k1.html#.decrypt">decrypt</a></li><li data-type="method" id="secp256k1-encrypt-nav"><a href="module-secp256k1.html#.encrypt">encrypt</a></li><li data-type="method" id="secp256k1-keyInfo-nav"><a href="module-secp256k1.html#.keyInfo">keyInfo</a></li><li data-type="method" id="secp256k1-sign-nav"><a href="module-secp256k1.html#.sign">sign</a></li></ul></li><li id="wallet-nav"><a href="module-wallet.html">wallet</a><ul class='methods'><li data-type="method" id="wallet-claimPayment-nav"><a href="module-wallet.html#.claimPayment">claimPayment</a></li><li data-type="method" id="wallet-createAccountForToken-nav"><a href="module-wallet.html#.createAccountForToken">createAccountForToken</a></li><li data-type="method" id="wallet-createPaymentLink-nav"><a href="module-wallet.html#.createPaymentLink">createPaymentLink</a></li><li data-type="method" id="wallet-getAccountForToken-nav"><a href="module-wallet.html#.getAccountForToken">getAccountForToken</a></li><li data-type="method" id="wallet-getPassportImage-nav"><a href="module-wallet.html#.getPassportImage">getPassportImage</a></li><li data-type="method" id="wallet-getPassportInfo-nav"><a href="module-wallet.html#.getPassportInfo">getPassportInfo</a></li><li data-type="method" id="wallet-getPaymentInfo-nav"><a href="module-wallet.html#.getPaymentInfo">getPaymentInfo</a></li><li data-type="method" id="wallet-getTokenBalance-nav"><a href="module-wallet.html#.getTokenBalance">getTokenBalance</a></li><li data-type="method" id="wallet-walletInit-nav"><a href="module-wallet.html#.walletInit">walletInit</a></li><li data-type="method" id="wallet-messageWallet-nav"><a href="module-wallet.html#~messageWallet">messageWallet</a></li></ul></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        index.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>/*
 * Copyright (c) 2018 Zippie Ltd.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
import * as appcache from './appcache'
import * as ipc from './ipc/'

/**
 * Vault API configuration options
 * 
 * @typedef {Object} Vault#VaultOpts
 * 
 * @property {string} vault_uri Specify custom vault location
 * @property {boolean} ipc-mode Specify running in IPC service mode only
 * 
 */

/**
 * Class for integrating Zippie platform into an application
 * 
 * @class Vault
 * 
 * @param {Vault#VaultOpts} opts Vault API configuration. (optional)
 * 
 * @returns {Vault} New vault instance
 * 
 * @example
 * const vault = new Vault({vault_uri: 'https://vault.dev.zippie.org'})
 * vault.setup()
 *  .then(_ => vault.signin())
 *  .then(_ => {
 *    console.info('Vault initialized')
 *  })
 *  .catch(e => { console.error(e) })
 * 
 */
export default class Vault {
  constructor (opts) {
    opts = opts || {}

    // Parse params from URI fragment
    this.__params = this.__parse_opts(window.location)

    // Strip params from URI fragment
    if (window.location.hash.indexOf('?') !== -1) {
      window.location.hash = window.location.hash.slice(0, window.location.hash.indexOf('?'))
    }

    // Enclave DOM objects
    this.__iframe = null
    this.__vault = null

    // Message receiver dispatch variables
    this.__callback_counter = 0
    this.__receivers = {}

    // Construct iframe to load vault enclave
    var iframe = document.createElement('iframe')

    iframe.style.display = 'none'

    iframe.sandbox += ' allow-storage-access-by-user-activation'
    iframe.sandbox += ' allow-same-origin'
    iframe.sandbox += ' allow-scripts'

    // Setup vault URI default if none provided in constructor opts.
    if (!opts.vault_uri) {
      opts.vault_uri = 'https://vault.zippie.org'

      if (window.location.host.split('.').indexOf('dev') !== -1) {
        opts.vault_uri = 'https://vault.dev.zippie.org'
      } else
      if (window.location.host.split('.').indexOf('testing') !== -1) {
        opts.vault_uri = 'https://vault.testing.zippie.org'
      }
    }

    // If vault URI set in local storage, it overrides above default.
    if (window.localStorage.getItem('zippie-vault-url') !== null) {
      opts.vault_uri = window.localStorage.getItem('zippie-vault-url')
    }

    // 'zippie-vault' query parameter overrides and persists to local storage.
    if (this.__params['zippie-vault'] !== undefined) {
      opts.vault_uri = this.__params['zippie-vault']
      window.localStorage.setItem('zippie-vault-url', opts.vault_uri)
    }

    // Add vault enclave iframe to DOM
    document.body.appendChild(iframe)

    this.__opts = opts
    this.__iframe = iframe
    this.__vault = iframe.contentWindow
  }


  /**
   * Initialize vault enclave by loading in vault source with magiccookie key
   * if we have one available. Resolves when enclave is ready for commands.
   * 
   * @method Vault#setup
   */
  async setup () {
    // Don't allow setup to be called multiple times.
    if (this.__onSetupReady !== undefined) return Promise.resolve()

    await ipc.init(this)

    console.info('VAULT-API: Setting up Zippie Vault enclave.')
    return new Promise(function (resolve, reject) {
      if ('ipc-mode' in this.__opts) {
        console.info('VAULT-API: Running in IPC mode.')

        // Setup async response handlers for when we hear "ready" from vault.
        this.__onSetupReady = resolve
        this.__onSetupError = reject

        // Setup incoming message handler.
        this.__on_message = this.__on_message.bind(this)
        this.__vault = window.parent

        window.addEventListener('message', this.__on_message)
        return resolve()
      }

      //   Get magic vault cookie by whatever means necessary, if provided via
      // query parameters, then save /new/ value to local storage.
      let magiccookie = window.localStorage.getItem('zippie-vault-cookie')
      if (this.__params['vault-cookie'] !== undefined) {
        magiccookie = this.__params['vault-cookie']
        window.localStorage.setItem('zippie-vault-cookie', magiccookie)
      }

      if (magiccookie === '') magiccookie = null

      //   If no magic cookie was discovered redirect to vault in root mode,
      // to pick up a new magic cookie, or require user sign up.
      if (!this.__params['inhibit-signup'] &amp;&amp; !magiccookie) {
        console.warn('VAULT-API: No vault cookie provided, redirecting to vault.')
        window.location = this.__opts.vault_uri +
          '#?launch=' + window.location + ';inhibit-signup'
        return reject()
      }

      // Setup incoming message handler.
      this.__on_message = this.__on_message.bind(this)
      window.addEventListener('message', this.__on_message)

      //   We have a magic cookie, which means we should have an identity
      // initialize vault with our cookie.
      if (magiccookie !== null) {
        console.info('VAULT-API: Found magic cookie:', magiccookie)
        this.__iframe.src = this.__opts.vault_uri + '#?magiccookie=' + magiccookie
      }  else {
        this.__iframe.src = this.__opts.vault_uri
      }

      // Setup async response handlers for when we hear "ready" from vault.
      this.__onSetupReady = resolve
      this.__onSetupError = reject

      console.info('VAULT-API: Loading vault from URI:', this.__iframe.src)
    }.bind(this))
  }


  /**
   * When vault is setup correctly, this function initiates a signin process
   * should be called from an interactive user component, like a button to work
   * correctly with Safari browsers that have ITP 2.0
   * 
   * @method Vault#signin
   * 
   * @param {Object} opts Options to pass to Vault during signin process.
   * @param {bool} noLogin (internal use only)
   */
  signin (opts, noLogin) {
    if (this.isSignedIn) return Promise.resolve()

    this.__signin_opts = opts || {}
    console.info('VAULT-API: Attempting to signin.')

    //   If we've been launched with inhibit-signup specified, and vault reports
    // no identity (no magiccookie set). Initiate signup process.
    let magiccookie = window.localStorage.getItem('zippie-vault-cookie')
    if (this.__params['inhibit-signup'] &amp;&amp; !magiccookie) {
      this.__signin_opts.launch = this.__signin_opts.launch || window.location.href
      let paramstr = ''
      Object.keys(this.__signin_opts).forEach(k => {
        paramstr += (paramstr.length === 0 ? '' : ';')
          + k + '=' + this.__signin_opts[k]
      })

      console.info('VAULT-API: Redirecting to:', this.__opts.vault_uri + '#?' + paramstr)
      window.location = this.__opts.vault_uri + '#?' + paramstr
      return Promise.reject()
    }

    return new Promise(function (resolve, reject) {
      if (noLogin) return resolve()

      //   Send 'login' message for ITP support.
      return this.message({login: null})
        .then(function (r) {
          console.info('VAULT-API: Vault reports ITP access granted.')

          this.__onSetupReady = resolve
          this.__onSetupError = reject

          // XXX - https://bugs.webkit.org/show_bug.cgi?id=188783
          //   This should cause a "ready" message down the line, which is
          // picked up by the above promise resolve/reject, which in turn
          // triggers the continuation of the signin process.
          this.message({reboot: null})

          if ('itp' in this.__params) {
            console.info('VAULT-API: ITP ITP ITP ITP')
            delete this.__params['itp']
          }
        }.bind(this))
        .catch(function (e) {
          if (e !== 'ITP_REQUEST_FAILURE') return Promise.reject(e)
          console.warn('VAULT-API: Vault reported ITP request failure, redirecting to vault for authorization.')
          window.location = this.__opts.vault_uri + '#?launch=' + window.location + ';itp'    
        }.bind(this))
    }.bind(this))

    .then(function (r) {
      if (this.isSignedIn === undefined) return Promise.reject('Not setup')

      return this.message({signin: this.__signin_opts})
    }.bind(this))

    .then(function (r) {
      if (r &amp;&amp; 'error' in r &amp;&amp; 'launch' in r &amp;&amp; !this.__signin_opts['inhibit-signup']) {
        this.__signin_opts.launch = this.__signin_opts.launch || window.location.href

        let paramstr = ''
        Object.keys(this.__signin_opts).forEach(k => {
          paramstr += (paramstr.length === 0 ? '' : ';')
            + k + '=' + this.__signin_opts[k]
        })

        window.location = r.launch + '#?' + paramstr
      }

      return appcache.init(this)
    }.bind(this))

    .catch(function (e) {
      if (e !== 'ITP_REQUEST_FAILURE') return Promise.reject(e)
      console.warn('VAULT-API: Vault reported ITP request failure, redirecting to vault for authorization.')
      window.location = this.__opts.vault_uri + '#?launch=' + window.location + ';itp'
    }.bind(this))
  }


  /**
   * Send a request to the vault enclave. Returns a promise that resolves
   * or rejects depending on the received result.
   * 
   * @method Vault#message
   * 
   * @param {Object} request Message to send
   * 
   * @returns {Promise}
   */
  message (req) {
    if (!this.__iframe) {
      return Promise.reject({ error: 'Vault not initialized.' })
    }

    return new Promise(function (resolve, reject) {
      let id = 'callback-' + this.__callback_counter++
      this.__receivers[id] = [resolve, reject]

      req.callback = id
      this.__vault.postMessage(req, '*')
    }.bind(this))
  }

  /**
   * Request identity enrollments, this is a list of devices and recovery
   * methods.
   * 
   * @method Vault#enrollments
   * 
   * @returns {Array} Users' enrollments
   */
  enrollments () {
    return this.message({ enrollments: null })
  }

  /**
   * Request this devices' identification information.
   * 
   * @method Vault#getDeviceInfo
   * 
   * @returns {DeviceInfo} Device information
   */
  getDeviceInfo () {
    return this.message({ getDeviceInfo: null })
  }

  /**
   * Request user data
   * 
   * @method Vault#getUserData
   * 
   * @returns {Any} Userdata
   */
  getUserData (id) {
    return this.message({ userdata: { get: { key: id } }})
  }

  /**
   * Assign user data.
   * 
   * @method Vault#setUserData
   * 
   * @param {string} id 
   * @param {Any} value 
   */
  setUserData (id, value) {
    return this.message({ userdata: { set: { key: id, value: value }}})
  }


  /**
   * Event handler for incoming messages from vault.
   * 
   * @access private
   */
  __on_message (event) {
      // Ignore messages not from vault
      if (event.source !== this.__vault) return

      // Ignore IPC messages which are handled in ipc module.
      if ('call' in event.data) return

      console.info('VAULT-API: Received message:', event.data)

      // If there's a receiver setup for this message, handle it.
      if (event.data.callback &amp;&amp; this.__receivers[event.data.callback]) {
        console.info('VAULT-API: Invoking message callback.')
        let receiver = this.__receivers[event.data.callback]
        delete this.__receivers[event.data.callback]

        // Call receiver promise reject
        if ('error' in event.data) return receiver[1](event.data.error)

        // Call receiver promise resolve
        return receiver[0](event.data.result)
      }

      if ('login' in event.data || 'ready' in event.data) {
        console.info('VAULT-API: processing vault login/ready message.')

        this.__get_vault_attr('version')()
          .then(this.__get_vault_attr('config'))
          .then(this.__get_vault_attr('isSignedIn'))
          .then(async function () {
            //   If we have a magiccookie from a previous session, then retrieve
            // it, and attempt an automatic signin, we can presume we've already
            // been granted cookie access from a previous session.
            let magiccookie = window.localStorage.getItem('zippie-vault-cookie')
            if ('ready' in event.data &amp;&amp; magiccookie) {
              return this.signin(this.__signin_opts, true)
                .then(this.__get_vault_attr('isSignedIn'))
                .then(function () {
                  if (this.isSignedIn) return appcache.init(this)
                }.bind(this))
                .then(this.__onSetupReady)
                .catch(e => { console.error(e) })
            }

            if (this.isSignedIn) await appcache.init(this)

            return this.__onSetupReady()
          }.bind(this))

        return
      }

      console.warn('VAULT-API: unhandled vault message event:', event)
  }

  /**
   * Parse hash query parameters into an object.
   * 
   * @access private
   */
  __parse_opts (uri) {
    let parser = document.createElement('a')
    parser.href = uri

    let hash = parser.hash
    let paramstr = hash.split('?')[1] || ''
    hash = hash.split('?')[0]

    let params = {}

    let p = paramstr.split(';')
    if (p[0] !== '') {
      for (let i = 0; i &lt; p.length; i++) {
        let parts = p[i].split('=')
        params[parts[0]] = parts[1]
      }
    }

    return params
  }


  /**
   *   Send vault message to request a vault, and store value in corrosponding
   * instance attribute.
   * 
   * @access private
   */
  __get_vault_attr (attr) {
    return function () {
      let mesg = {}
      mesg[attr] = null
      return this.message(mesg).then(function (r) { this[attr] = r }.bind(this))
    }.bind(this)
  }
}

</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
